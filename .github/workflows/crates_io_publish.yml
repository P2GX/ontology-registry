name: Crates.io publish
on:
  release:
    types: [ published ]

jobs:

  release:
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install cargo-edit
        run: |
          cargo install cargo-edit

      - name: Set Version in env from Tag
        id: set_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Setting version to: $VERSION"
          
          # Update Cargo.toml and Cargo.lock
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Get package name
        id: package_name
        run: |
          PACKAGE_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
          echo "name=$PACKAGE_NAME" >> "$GITHUB_OUTPUT"

      - name: Set version in cargo.toml
        run: cargo set-version ${{steps.set_version.outputs.version}}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PERSONAL_TOKEN}}
          commit-message: "chore: automated version bump"
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: version-bump-${{steps.set_version.outputs.version}}
          base: main
          delete-branch: true
          title: '[Automated] Update Version'
          body: |
            This PR was automatically created by GitHub Actions.
            It should only contain a version bump in the cargo.toml. Its necessary to merge, as a new version of this repo has just been released.
          labels: |
            automated
            publish
            documentation

      - name: Publish
        run: |
          cargo publish --token ${{secrets.CARGO_REGISTRY_TOKEN}} --allow-dirty --dry-run --color always

